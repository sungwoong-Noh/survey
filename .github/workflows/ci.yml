name: Survey CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 2. JDK ì„¤ì • (Set up JDK)    #   - actions/setup-java@v4 ì•¡ì…˜ì„ ì‚¬ìš©í•´ì„œ Java í™˜ê²½ì„ ì„¤ì •í•´.
      #   - 'temurin'ì€ Eclipse Temurin ë°°í¬íŒì„ ì˜ë¯¸í•´. ê°€ì¥ í‘œì¤€ì ì´ì•¼.
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ìºì‹± ì„¤ì • (Optional, but Recommended for speed)    #   - actions/cache@v4 ì•¡ì…˜ì„ ì‚¬ìš©í•´ì„œ Gradleì´ ë‹¤ìš´ë¡œë“œí•œ ë¼ì´ë¸ŒëŸ¬ë¦¬(dependencies)ë“¤ì„ ìºì‹±í•´.
      #   - ì´ë ‡ê²Œ í•˜ë©´ ë‹¤ìŒ ì‹¤í–‰ë¶€í„°ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ì‹œ ë‹¤ìš´ë°›ì§€ ì•Šì•„ì„œ ë¹Œë“œ ì†ë„ê°€ ì—„ì²­ë‚˜ê²Œ ë¹¨ë¼ì ¸
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches  
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-  

      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (Grant execute permission for gradlew)     #   - gradlew ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ì‹¤í–‰ ê¶Œí•œì´ í•„ìš”í•´.
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew


      # 5. Gradleë¡œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Build and Test with Gradle)    #   - ë“œë””ì–´ í•µì‹¬ ë‹¨ê³„! gradlew ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•´ì„œ 'build' íƒœìŠ¤í¬ë¥¼ ì‹¤í–‰í•´.
      #   - Gradleì˜ 'build' íƒœìŠ¤í¬ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì»´íŒŒì¼(compileJava)ê³¼ í…ŒìŠ¤íŠ¸(test)ë¥¼ ëª¨ë‘ í¬í•¨í•˜ê³  ìˆì–´.
      #   - í…ŒìŠ¤íŠ¸ê°€ í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì´ ë‹¨ê³„ì—ì„œ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨ ì²˜ë¦¬ë˜ê³ , PRì— ë¹¨ê°„ë¶ˆì´ ë“¤ì–´ì˜¬ ê±°ì•¼.
      - name: Build and Gradle
        run: ./gradlew build


      # 6. AWS ìê²©ì¦ëª… ì„¤ì • (Configure AWS credentials)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # ğŸ‘ˆ ECR Publicì€ us-east-1 ë¦¬ì „ë§Œ ì§€ì›

      # 7. AWS ECR Public ë¡œê·¸ì¸ (Login to Amazon ECR Public)
      - name: Login to Amazon ECR Public
        id: login-ecr-public
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registry-type: public  # ğŸ‘ˆ Public Registry ì§€ì •

      # 8. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR Public í‘¸ì‹œ (Build and push Docker image to ECR Public)
      - name: Build and push Docker image to ECR Public
        env:
          ECR_REGISTRY: public.ecr.aws
          ECR_REPOSITORY: o3q0p5x7/e-commerce_1  # ğŸ‘ˆ ì½˜ì†”ì—ì„œ ë³¸ ê²½ë¡œ
        run: |
          echo "Building Docker image..."
#          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker build -t e-commerce_1 .
          docker tag e-commerce_1:latest public.ecr.aws/o3q0p5x7/e-commerce_1:latest
          
          echo "Pushing Docker image to ECR Public..."
#          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push public.ecr.aws/o3q0p5x7/e-commerce_1:latest
          
          echo "Image pushed successfully!"
          echo "Image URI: $ECR_REGISTRY/$ECR_REPOSITORY:latest"
      